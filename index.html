<!DOCTYPE html>
<!--[if (gte IE 9)|!(IE)]><!--> <html lang="en"> <!--<![endif]-->
<head>
<title>Trend Grid</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1.0, maximum-scale=1.0">
<link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>

<div id="align">
    <a href="" id="cont" class="button" title="Auto"></a>
    <a href="" id="prev" class="button"></a>
    <div id="trends"></div>
    <a href="" id="next" class="button"></a>
    <div id="grid">
        <div id="mover"></div>
    </div>
</div>
<script type="text/javascript" src="cordova-2.0.0.js"></script>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript">

document.addEventListener("offline", onOffline, false);
if (!navigator.onLine) {
  onOffline();
}

function onOffline() {
    $('#align').html('<h2>A network connection is required.</h2>')
}
/*
 * Trend Grid v0.8
 * An animated news grid populated by Google News results from current Google Trends keywords
 * Author: Nathan Blenke
 * Updated: 20120530
 * http://nathan.blenke.com/workshop/trendgrid/
 * License: http://creativecommons.org/licenses/by-nc-sa/3.0/
 */

var z = {
    count: 0,
    an2: [],
    an3: [],
    an4: [],
    interval: 7000,
    move: 3500,
    speed: 500,

    init : function () {
        z.mq();
        z.loader();
        z.trends();
        $(window).resize(function () {
            z.mq();
            z.loader();
        });
        z.storage('show');
    },

    loader : function () {
        $('#grid ul:eq(0) li:eq(0)').prepend('<div id="loader"></div>')
            .find('#loader').delay(3000).fadeOut(500);
    },

    storage : function (type, event) { 
        try {
            var aStories = JSON.parse(window.localStorage['stories']);

            switch (type) {
            case 'show':
                aStories.reverse();
                for (var i = 0; i < aStories.length; i += 1) {
                    if (aStories[i].length) {
                        $('#grid').after('<div class="detail">' + aStories[i] + '</div>');
                    }
                }
                z.detail();
                break;
            case 'remove':
                var elparent = $(event.currentTarget).parents('.detail')
                    astories = [];
                elparent.remove();

                $('.detail').each(function (i) {
                    astories[i] = $(this).html();
                });
                
                astories = $.grep(astories, function(value) {
                  return value != elparent.index('.detail');
                });
                
                window.localStorage['stories'] = JSON.stringify(astories);
                break;
            }
        } catch (e) {}
    },
    
    anbuild : function (x, z, c) {
        var a = [x],
            i = 0;
        while (i < c) {
            x = x + z;
            a.push(x);
            i += 1;
        }
        return a;
    },

    mq : function () {
        switch ($('#align').width()) {
        case 300:
            z.grid(300);
            z.count = 1;
            break;
        case 460:
            z.grid(460);
            z.count = 2;
            z.an2 = z.anbuild(1, 2, 14);
            break;
        case 748:
            z.grid(748);
            z.count = 3;
            z.an2 = z.anbuild(1, 3, 14);
            z.an3 = z.anbuild(2, 3, 14);
            break;
        default:
            z.grid();
            z.count = 4;
            z.an2 = z.anbuild(1, 4, 14);
            z.an3 = z.anbuild(2, 4, 14);
            z.an4 = z.anbuild(3, 4, 14);
        }
    },
    
    truncate : function (str, amount) {
        var trailing = amount - 3;
        if (str.length > trailing) {
            str = str.substring(0, trailing) + '...';
        }
        return str;
    },
    
    go : function (txt, lnk, cnt) {

        var item,
            incr = 0,
            trunc = 110,
            elimg = cnt.split('src="')[1].split('"')[0];

        if (elimg.substring(0, 2) === '//') {
            elimg = 'http:' + elimg;
        }
        if (cnt.search(/src=/i) !== -1) {
            item = $('<div class="item">' +
                      '<img src="' + elimg + '" class="thumb">' +
                      '<h6>' + z.truncate(txt, trunc) + '</h6>' +
                      '<p>' + cnt + '<a href="' + lnk + '">More</a></p>' +
                      '</div>');
        } else {
            item = $('<div class="item" data-link="' + lnk + '">' +
                      '<h6>' + z.truncate(txt, trunc) + '</h6>' +
                      '<p>' + cnt + '<a href="' + lnk + '">More</a></p>' +
                      '</div>');
        }

        $('#mover').append(item);

        $('#trends a').click(function () {
            var p = incr + 58;

            item.each(function () {
                $(this).animate({
                    top: p + 'px'
                }, z.speed);
            });

        });

        setInterval(function () {
            incr = incr + 58;
            item.animate({
                top: incr + 'px'
            }, z.speed);
            $('.item[style*="406px"]').remove();
        }, z.move);

        item.each(function () {

            var el = $(this),
                ii = el.index(),
                astories = [],
                convArObjLit = function (a) {
                    var i = 0,
                        o = {};
                    for (i; i < a.length; i += 1) {
                        o[a[i]] = '';
                    }
                    return o;
                };

            if (ii in convArObjLit(z.an2)) {
                el.addClass('n2');
            }
            if (ii in convArObjLit(z.an3)) {
                el.addClass('n3');
            }
            if (ii in convArObjLit(z.an4)) {
                el.addClass('n4');
            }

            el.hover(function () {
                el.addClass('hover');
            }, function () {
                el.removeClass('hover');
            });

            el.click(function () {

                $('#grid').after('<div class="detail" style="display:none">' + $(this).html() + '</div>');
 
                $(this).addClass('clicked');
                $(this).animate({
                    top: '420px'
                }, z.speed, function () {
                    $(this).remove();
                });

                $('.detail:eq(0)').delay(z.speed).slideDown(z.speed);
                
                z.detail();
                
                $('.detail').each(function (i) {
                    astories[i] = $(this).html();
                });
              
                try {
                    window.localStorage['stories'] = JSON.stringify(astories);
                } catch (e) {}
                
                
            });

        });

    },
    
    detail : function () {
        $('.detail').each(function () {
            var el = $(this),
                oas = el.find('a:eq(0)').attr('href');

            el.prepend('<a href="' + oas + '" class="more detail-btn">&raquo;</a>' +
                       '<a href="" class="remove detail-btn">&times;</a>');
            el.find('a.more:gt(0), a.remove:gt(0)').remove();
            el.find('a:contains("More")').remove();

			var strImgSrc = $(this).find('img').attr('src');
			if (strImgSrc.substring(0, 2) === '//') {
				strImgSrc = 'http:' + strImgSrc;
			}
			$(this).find('img').attr('src', strImgSrc);
        });
                  
        $('.detail a').attr('target', '_blank');
        $('.detail:gt(19)').remove();
        $('.detail:eq(19)').addClass('detail0');
        $('.detail:eq(18)').addClass('detail1');
        $('.detail:eq(17)').addClass('detail2');
        $('.detail:eq(16)').addClass('detail3');
        
        $('.remove').click(function (event) {
            z.storage('remove', event);
            return false;
        });
    },

    grid : function (size) {
        var intRows,
            intCols,
            intRowIt = 0,
            intColIt = 0,
            intUlWidth,
            intLiWidth,
            fprepend = function () {
                $('#grid ul').each(function () {
                    $(this).prepend("<li data-col='" + intColIt + "'></li>");
                });
            };

        $('#grid ul').remove();

        switch (size) {
        case 300:
            intRows = 5;
            intCols = 0;
            intUlWidth = 300;
            intLiWidth = 300;
            break;
        case 460:
            intRows = 5;
            intCols = 1;
            intUlWidth = 460;
            intLiWidth = 229;
            break;
        case 748:
            intRows = 5;
            intCols = 2;
            intUlWidth = 748;
            intLiWidth = 248;
            break;
        default:
            intRows = 6;
            intCols = 3;
            intUlWidth = 980;
            intLiWidth = 244;
        }

        for (intRowIt = 0; intRowIt <= intRows; intRowIt += 1) {
            $('#grid').prepend("<ul data-row='" + intRowIt + "'></ul>");
        }

        for (intColIt = 0; intColIt <= intCols; intColIt += 1) {
            fprepend();
        }

        $('#grid ul').each(function () {
            $(this).css('width', intUlWidth + 'px');
            $(this).find('li').css('width', intLiWidth + 'px')
                .css('height', '57px');
        });

    },

    gapi : function (url, fnk, num, key) {
        if (url == null) {
            return false;
        }
        var gurl = "http://ajax.googleapis.com/ajax/services/feed/load?v=1.0&callback=?&q=" + encodeURIComponent(url);

        if (num != null) {
            gurl += "&num=" + num;
        }
        if (key != null) {
            gurl += "&key=" + key;
        }
        $.getJSON(gurl, function (data) {
            if (typeof fnk == 'function') {
                try {
                    fnk.call(this, data.responseData.feed);
                } catch (e) {}
            } else {
                return false;
            }
        });
    },

    trends : function (size) {
        z.gapi('http://www.google.com/trends/hottrends/atom/hourly', function (feeds) {

            var i = 0,
                im = 0,
                aTrends = [],
                iTimerId = 0,
                ipos,
                iend;

            if (!feeds) {
                return false;
            }
            for (i; i < feeds.entries.length; i += 1) {
                $('#trends').prepend(feeds.entries[i].content);
            }

            $('#trends a').each(function () {
                var el = $(this),
                    bc = false,
                    fnon = function () {
                        el.parents('li').siblings().removeClass('on');
                        el.parents('li').addClass('on');
                        z.feed(el.text());
                    };

                aTrends.push(el.text());
                el.attr('href', '').click(function () {
                    if (!bc) {
                        bc = true;
                        if ($(this).parents('li').is(':last-child')) {
                            fnon();
                            $('#cont').hide();
                            $('#trends').removeClass('trendscont');
                            iTimerId = setTimeout(function () {
                                getTrend(0, size);
                                z.feed(aTrends[0]);
                            }, z.interval);
                        } else {
                            fnon();
                            $('#cont').show();
                            $('#trends').addClass('trendscont');
                            clearTimeout(iTimerId);
                        }
                        setTimeout(function () {
                            bc = false;
                        }, 10000);
                    }
                    return false;
                });
            });

            function getTrend(x, size) {
                var ocur = $('#trends li:eq(' + x + ')'),
                    osibs = $('#trends li'),
                    ionlngth = $('.on').attr('data-pos') - 100;

                osibs.removeClass('on');
                ocur.addClass('on');

                if (x === 0) {
                    ionlngth = 0;
                }

                $('#trends ol').animate({
                    "marginLeft": '-' + ionlngth + 'px'
                }, z.speed);

                iTimerId = setTimeout(function () {
                    if (x === 20) {
                        x = 0;
                    }
                    if (x <= 19) {
                        getTrend(x, size);
                        z.feed(aTrends[x]);
                    }
                }, z.interval);

                x += 1;
            }
            getTrend(0, size);
            z.feed(aTrends[0]);

            $('li').each(function () {
                i = i + $(this).width();
                $(this).attr('data-pos', i);
                im = im + 10;
            });

            $('#trends ol').css('width', $('#trends li:last').attr('data-pos') + 'px');
            $('#trends ol').css('width', $('#trends ol').width() + im + 'px');

            iend = parseFloat('-' + $('#trends li:last').attr('data-pos')) + 400;

            $('#next').click(function () {
                ipos = parseFloat($('#trends ol').css('margin-left').split('px')[0]);
                if (ipos >= iend) {
                    $('#trends ol').animate({
                        "marginLeft": ipos - 230 + 'px'
                    }, z.speed);
                }
                clearTimeout(iTimerId);
                $('#cont').show();
                $('#trends').addClass('trendscont');
                return false;
            });

            $('#prev').click(function () {
                ipos = parseFloat($('#trends ol').css('margin-left').split('px')[0]);
                if (ipos <= 0) {
                    $('#trends ol').animate({
                        "marginLeft": ipos + 230 + 'px'
                    }, z.speed);
                }
                clearTimeout(iTimerId);
                $('#cont').show();
                $('#trends').addClass('trendscont');
                return false;
            });

            $('#cont').click(function () {
                var x = $('#trends ol li.on').index();
                iTimerId = setTimeout(function () {
                    getTrend((x + 1), size);
                    z.feed(aTrends[(x + 1)]);
                }, z.interval);
                $(this).hide();
                $('#trends').removeClass('trendscont');
                z.loader();
                return false;
            });

        }, 1);

    },

    feed : function (query) {
        var arr = {
            search0: 'http://news.google.com/news?pz=1&cf=all&ned=us&hl=en&num=10&cf=all&output=rss&q=' + encodeURIComponent(query)
        };
        $.each(arr, function (key, value) {
            z.gapi(value, function (feeds) {
                var i = 0;
                if (!feeds) {
                    return false;
                }
                for (i; i < feeds.entries.length; i += 1) {
                    z.go(feeds.entries[i].title, feeds.entries[i].link, feeds.entries[i].content);
                }
            }, z.count);
        });

    }

};

jQuery(function ($) {
    z.init();
});


var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-2411695-1']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>

</body>
</html>

